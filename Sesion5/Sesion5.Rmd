---
title: "Sesi贸n 5: An谩lisis de Supervivencia y Preparaci贸n de Datos"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#  Directorio de trabajo en R

R necesita saber en qu茅 carpeta buscar y guardar archivos. Esta carpeta se llama **directorio de trabajo**.

```{r}
# Ver el directorio de trabajo actual
getwd()

# Cambiar el directorio de trabajo (ajusta a tu ruta)
setwd("D:/Taller_R")
```

---

#  Importaci贸n de archivos

## 1. Usando la interfaz gr谩fica

En RStudio:
- Ve a "Import Dataset" > "From Text (base)"
- Busca el archivo (evita acentos, espacios y guiones en el nombre)
- Aseg煤rate de seleccionar `Header = Yes` si el archivo tiene encabezados.

## 2. V铆a c贸digo
Es muy recomendable familiarizarse con este entorno si en alg煤n momento se desea trabajar con datos que requieren mayor capacidad de c贸mputo, ya que los equipos con mayor rendimiento suelen carecer de interfaz gr谩fica y todo se gestiona mediante l铆nea de comandos.

Existen dos formas de indicar una ruta:

```{r}
# Establece el directorio y revisa archivos disponibles
setwd("D:/Taller_R/Sesion5")
list.files()

# Opci贸n 1: Ruta relativa. Estando posicionado en el directorio
tabla_ejercicio <- read.csv("tabla_ejercicio.csv", header = T, row.names = 1)

# Opci贸n 2: Ruta completa (Recomendado)
tabla_ejercicio <- read.csv("D:/Taller_R/Sesion5/tabla_ejercicio.csv", header = T, row.names = 1)
```

---

#  Instalaci贸n de paquetes

Es recomendable instalar versiones espec铆ficas para reproducibilidad.

```{r}
# Remover `#` si es la primera vez que se instala
#install.packages("remotes", repos = "https://cloud.r-project.org")

#remotes::install_version("survival", version = "3.5.5")
#remotes::install_version("survminer", version = "0.5.0")
```

Luego carga las librer铆as:

```{r}
library(survival)
library(survminer)
```

---

#  Preparaci贸n de los datos con `ifelse()`

Con un inspeccion rapida con `head` podemos notar que el status del paciente (Event) no est谩 en el formato adecuado

```{r}
# Revisar los primeros registros
head(tabla_ejercicio)

# Re-codificar columna 'Event': transformar "0:LIVING" en 0 y todo lo dem谩s en 1
tabla_ejercicio$Event <- ifelse(tabla_ejercicio$Event == "0:LIVING", 0, 1)
head(tabla_ejercicio)
```

---

##  Agrupaci贸n basada en la expresi贸n de un gen

Debemos crear una columna que indique como se van a agrupar nuestras muestras.
Queremos clasificar las muestras en funci贸n de la expresi贸n de TP53.

```{r}
# Averiguar el rango de expresi贸n
quantile(tabla_ejercicio$TP53)
```
Basado en el rango de los datos, proponemos 1 como limite para catalogar muestras como "High" y -1 para catalogar muestras como "Low"

```{r}
# Clasificaci贸n en 3 grupos usando ifelse anidados
# Colocar el agrupamiento en una nueva columna dentro del dataframe
tabla_ejercicio$Group <- ifelse(tabla_ejercicio$TP53 > 1, "High",
                                ifelse(tabla_ejercicio$TP53 < -1, "Low", "Medium"))

# Ver n煤mero de muestras por grupo
table(tabla_ejercicio$Group)
```

**Nota**: Se recomienda eliminar el grupo "Medium" para contrastar s贸lo casos extremos:

```{r}
surv_ready <- tabla_ejercicio[tabla_ejercicio$Group != "Medium", ]
```

---

#  An谩lisis de Supervivencia

Debemos indicar las columnas donde viene el tiempo (Months), status (vivo o muerto) (Event) y la agrupaci贸n de las muestras (Group)

```{r}
# Crear modelo de supervivencia
km.results <- survfit(Surv(Months, Event) ~ Group, data = surv_ready)

# Grafica sencilla, solo necesita 2 parametros.
ggsurvplot(fit = km.results, data = surv_ready)
```

###  Gr谩fica personalizada con mas par谩metros

```{r}
ggsurvplot(fit = km.results, data = surv_ready, 
           pval = TRUE,
           # Tabla especificando pacientes remanentes en el estudio y su respectivo status
           risk.table = "nrisk_cumevents",
           break.x.by = 50)
```

Esto mostrar谩 la curva de supervivencia por grupo, el valor de *p* y una tabla con el n煤mero de pacientes remanentes en cada tiempo.
